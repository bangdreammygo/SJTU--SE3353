# 13-mysql backup & recovery 

+ 备份你的数据库很重要
  + 这样，您可以恢复数据，并在出现问题时再次启动并运行，例如系统崩溃、硬件故障或用户错误删除数据。
  + 在升级MySQL安装之前（比如mysql5升级到mysql8），备份也是必不可少的保障措施，它们可用于将MySQL安装传输到另一个系统或设置副本服务器。

+ 应该熟悉的几个备份和恢复主题(topic)：
  + 备份类型：逻辑备份与物理备份、完整备份与增量备份等。
  + 创建备份的方法。
  + 恢复方法，包括时间点恢复。
  + 备份调度、压缩和加密。
  + 表维护，以恢复损坏的表。

## 物理备份与逻辑备份

### 物理备份（原始备份）
- **定义**：由存储数据库内容的目录和文件的原始副本组成。
- **特点**：
  - 直接复制数据库的物理文件（如数据文件、日志文件）。
  - 恢复速度快，适合大型重要数据库。
- **适用场景**：
  - 需要快速恢复的数据库。
  - 大规模数据备份和灾难恢复。

---

### 逻辑备份
- **定义**：保存以逻辑数据库结构（如 `CREATE DATABASE`、`CREATE TABLE` 语句）和内容（如 `INSERT` 语句或分隔文本文件）表示的信息。
- **特点**：
  - 以逻辑数据结构为单位进行备份。
  - 可编辑数据值或表结构，适合跨平台迁移。
- **适用场景**：
  - 较小的数据量。
  - 需要选择性恢复或数据迁移的场景。
  - 在不同机器架构上重新创建数据。

---

### 对比总结
| **特性**         | **物理备份**                           | **逻辑备份**                     |
| ---------------- | -------------------------------------- | -------------------------------- |
| **备份内容**     | 数据库的物理文件（数据文件、日志文件） | 逻辑结构（SQL 语句或文本文件）   |
| **恢复速度**     | 快                                     | 较慢                             |
| **适用场景**     | 大型数据库、快速恢复                   | 小型数据库、数据迁移、选择性恢复 |
| **跨平台兼容性** | 依赖存储结构，平台相关                 | 可跨平台使用                     |
| **编辑灵活性**   | 不可编辑                               | 可编辑数据值或表结构             |

## 在线备份与离线备份

### 在线备份
- **定义**：在 MySQL 服务器运行时进行备份，直接从服务器获取数据库信息。
- **特点**：
  - 服务器保持运行状态。
  - 备份过程对其他客户端的影响较小。
  - 客户端可以在备份期间连接并访问数据（取决于操作类型）。
- **注意事项**：
  - 需要实施适当的锁定机制，以防止数据修改影响备份完整性。
  - MySQL 企业备份产品会自动处理此类锁定。
- **适用场景**：
  - 需要高可用性的系统。
  - 不允许停机的生产环境。

---

### 离线备份
- **定义**：在 MySQL 服务器停止时进行备份。
- **特点**：
  - 服务器完全停止运行。
  - 备份过程不会受到数据修改的影响。
  - 备份期间客户端无法访问数据库。
- **注意事项**：
  - 由于服务器在备份期间不可用，客户端可能会受到不利影响。
  - 通常从副本进行备份，以避免影响主服务器的可用性。
  - 备份程序更简单，因为没有客户端活动干扰的可能性。
- **适用场景**：
  - 允许停机的维护窗口。
  - 对数据一致性要求极高的场景。

---

### 热备份、冷备份与暖备份
- **热备份（在线备份）**：
  - 服务器运行，数据可访问。
  - 备份过程中允许数据修改（需锁定机制）。
- **冷备份（离线备份）**：
  - 服务器停止，数据不可访问。
  - 备份过程中无数据修改。
- **暖备份**：
  - 服务器运行，但数据库文件被锁定，防止数据修改。
  - 允许外部访问数据库文件。

---

### 在线备份的特点
1. **侵入性较小**：
   - 备份期间客户端可以连接并访问数据。
   - 对业务影响较小。
2. **锁定机制**：
   - 必须确保备份期间数据不被修改。
   - MySQL 企业备份产品会自动处理锁定。
3. **适用性**：
   - 适合需要高可用性和持续运行的系统。

---

### 离线备份的特点
1. **客户端影响**：
   - 服务器在备份期间不可用，客户端可能会受到不利影响。
   - 通常从副本进行备份，以避免影响主服务器的可用性。
2. **备份程序简单**：
   - 没有客户端活动干扰的可能性。
   - 备份过程更稳定，数据一致性更高。

---

### 恢复操作的在线与离线
- **在线恢复**：
  - 服务器运行，但恢复过程需要更强的锁定机制。
  - 客户端比在线备份更有可能受到影响，因为恢复会修改数据。
  - 必须阻止客户端访问数据，以确保恢复的完整性。
- **离线恢复**：
  - 服务器停止运行，恢复过程不受客户端活动干扰。
  - 适合对数据一致性要求极高的场景。

---

### 对比总结
| **特性**       | **在线备份**                 | **离线备份**             |
| -------------- | ---------------------------- | ------------------------ |
| **服务器状态** | 运行中                       | 停止                     |
| **数据访问**   | 客户端可访问（需锁定机制）   | 客户端不可访问           |
| **备份完整性** | 需锁定机制防止数据修改       | 无数据修改，完整性高     |
| **适用场景**   | 高可用性、不允许停机的系统   | 允许停机的维护窗口       |
| **客户端影响** | 较小（需锁定机制）           | 较大（服务器不可用）     |
| **恢复操作**   | 需更强锁定，客户端可能受影响 | 无客户端干扰，恢复更稳定 |

## 本地备份与远程备份

### 本地备份
- **定义**：在运行 MySQL 服务器的同一主机上执行备份。
- **特点**：
  - 备份文件直接存储在服务器主机上。
  - 适用于小型数据库或单机环境。
- **工具示例**：
  - `mysqldump`（可本地连接）。
  - `SELECT ... INTO OUTFILE`（输出文件在服务器主机上创建）。

---

### 远程备份
- **定义**：从不同的主机连接到 MySQL 服务器进行备份。
- **特点**：
  - 备份文件可以存储在远程主机上。
  - 适用于分布式环境或需要异地备份的场景。
- **工具示例**：
  - `mysqldump`（可远程连接）。
  - 物理备份方法（如文件复制到远程目的地）。

---

### 快照备份
- **定义**：利用文件系统的快照功能，创建文件系统在某一时间点的逻辑副本。
- **特点**：
  - 不需要复制整个文件系统。
  - 使用copy on write技术，仅复制快照后修改的部分。
- **实现方式**：
  - MySQL 本身不支持快照功能。
  - 依赖第三方解决方案（如 Veritas、LVM 或 ZFS）。
- **适用场景**：
  - 需要快速备份和恢复的大型数据库。
  - 对备份速度和存储空间有较高要求的场景。

---

### 对比总结
| **特性**     | **本地备份**                           | **远程备份**              | **快照备份**                   |
| ------------ | -------------------------------------- | ------------------------- | ------------------------------ |
| **执行位置** | 服务器主机                             | 远程主机                  | 服务器主机（依赖文件系统）     |
| **存储位置** | 服务器主机                             | 远程主机                  | 服务器主机                     |
| **适用场景** | 小型数据库、单机环境                   | 分布式环境、异地备份      | 大型数据库、快速备份与恢复     |
| **依赖工具** | `mysqldump`、`SELECT ... INTO OUTFILE` | `mysqldump`、物理备份方法 | Veritas、LVM、ZFS 等第三方工具 |


## 完整备份与增量备份

### 完整备份
- **定义**：备份 MySQL 服务器在给定时间点管理的所有数据。
- **特点**：
  - 包含所有数据，恢复简单。
  - 占用存储空间较大。
- **适用场景**：
  - 首次备份。
  - 定期全量备份。

### 增量备份
- **定义**：备份在给定时间段内（从一个时间点到另一个时间点）对数据所做的更改。
- **特点**：
  - 仅备份变化的数据，节省存储空间。
  - 恢复时需要依赖完整备份和所有增量备份。
- **实现方式**：
  - 启用服务器的二进制日志，记录数据更改。
- **适用场景**：
  - 频繁备份。
  - 节省存储空间。

---

## 备份调度、压缩和加密

### 备份调度
- **定义**：自动化备份程序，按计划执行备份任务。
- **优点**：
  - 减少人为操作错误。
  - 确保备份的及时性和一致性。

### 备份压缩
- **定义**：压缩备份输出，减少存储空间需求。
- **优点**：
  - 节省存储空间。
  - 提高备份效率。
- **实现方式**：
  - MySQL 企业备份产品支持 InnoDB 备份压缩。
  - 使用文件系统实用程序（如 gzip）进行压缩。

### 备份加密
- **定义**：加密备份输出，防止未经授权访问。
- **优点**：
  - 提高数据安全性。
  - 防止数据泄露。
- **实现方式**：
  - 使用文件系统实用程序（如 OpenSSL）进行加密。
  - 第三方解决方案可能提供更多功能。

## 使用 MySQL 企业备份进行热备份

### MySQL 企业备份
- **定义**：MySQL 企业版客户可以使用 MySQL 企业备份产品进行物理备份。
- **特点**：
  - 支持对整个实例、选定的数据库或表进行备份。
  - 提供增量和压缩备份功能。
  - 备份物理数据库文件，恢复速度比逻辑备份（如 `mysqldump`）快。
- **备份机制**：
  - **InnoDB 表**：使用热备份机制（服务器运行，数据可访问）。
  - **其他存储引擎表**：使用暖备份机制（服务器运行，但锁定数据文件）。
- **适用场景**：
  - 需要快速恢复的大型数据库。
  - 对备份速度和存储空间有较高要求的场景。

---

## 使用 `mysqldump` 进行备份

### `mysqldump` 备份
- **定义**：`mysqldump` 程序可以备份各种表。
- **特点**：
  - 支持逻辑备份，生成 SQL 文件。
  - 对于 InnoDB 表，可以使用 `--single-transaction` 选项执行在线备份，不锁定表。（在备份过程中别人只读不写）
- **适用场景**：
  - 小型数据库或需要跨平台迁移的场景。
  - 需要选择性备份或编辑数据的场景。

---

## 通过复制表文件进行备份

### MyISAM 表备份
- **方法**：复制表文件（`*.MYD`、`*.MYI` 和 `*.sdi` 文件）。
- **步骤**：
  1. 停止服务器或锁定并刷新相关表：（刷盘，读锁）
     ```sql
     FLUSH TABLES tbl_list WITH READ LOCK;
     ```
  2. 复制数据库目录中的表文件。
  3. 释放锁：
     ```sql
     UNLOCK TABLES;
     ```
- **特点**：
  - 只需读取锁，允许其他客户端继续查询表。
  - 需要刷新以确保所有活动索引页面写入磁盘。
- **限制**：
  - 不适用于 InnoDB 表。
  - InnoDB 可能缓存数据在内存中，未刷新到磁盘。

---

## 进行分隔文本文件备份

### 使用 `SELECT ... INTO OUTFILE`
- **方法**：将表数据导出为文本文件。
  ```sql
  SELECT * INTO OUTFILE 'file_name' FROM tbl_name;
  ```
- **特点**：
  - 文件在 MySQL 服务器主机上创建。
  - 输出文件不能已存在（防止安全风险）。
  - 仅保存表数据，不保存表结构。
- **适用场景**：
  - 需要导出表数据的场景。

### 使用 `mysqldump` 的 `--tab` 选项
- **方法**：生成分隔文本数据文件和表结构文件。
  ```bash
  mysqldump --tab=/path/to/output/dir db_name tbl_name
  ```
- **特点**：
  - 生成两个文件：数据文件（`.txt`）和表结构文件（`.sql`）。
  - 适合需要同时备份数据和结构的场景。

### 重新加载分隔文本文件
- **方法**：使用 `LOAD DATA` 或 `mysqlimport`。
  ```sql
  LOAD DATA INFILE 'file_name' INTO TABLE tbl_name;
  ```
  ```bash
  mysqlimport db_name file_name
  ```
- **适用场景**：
  - 需要快速导入数据的场景。

---

## 使用二进制日志进行增量备份

### 增量备份
- **定义**：MySQL 支持使用二进制日志进行增量备份。
- **特点**：
  - 二进制日志文件记录了数据库的所有更改。
  - 增量备份包含自上次完整备份或增量备份以来的所有更改。
- **步骤**：
  1. 在需要创建增量备份时，使用 `FLUSH LOGS` 命令轮换二进制日志。
  2. 下次进行完整备份时，同样使用 `FLUSH LOGS` 或 `mysqldump --flush-logs` 轮换二进制日志。
- **适用场景**：
  - 需要频繁备份且节省存储空间的场景。

---

## 使用副本进行备份（主从备份）

### 副本备份
- **定义**：如果备份时主服务器性能受到影响，可以通过设置复制并在副本上进行备份。
- **特点**：
  - 备份副本而非源服务器，减少对主服务器的影响。
  - 需要备份副本的连接元数据存储库和应用元数据存储库。
- **注意事项**：
  - 如果副本正在复制 `LOAD DATA` 语句，还需备份 `SQL_LOAD-*` 文件。
  - 这些文件用于恢复中断的 `LOAD DATA` 操作。
- **适用场景**：
  - 高负载生产环境，需要减少备份对主服务器的影响。

---

## 恢复损坏的表

### 恢复方法
- **MyISAM 表恢复**：
  - 使用 `REPAIR TABLE` 或 `myisamchk -r` 命令尝试修复损坏的表。
  - 在 99.9% 的情况下可以成功修复。
- **适用场景**：
  - 表损坏但数据未完全丢失的情况。

---

## 使用文件系统快照进行备份

### Veritas 文件系统快照
- **步骤**：
  1. 在客户端程序中执行 `FLUSH TABLES WITH READ LOCK`。
  2. 在另一个 shell 中执行 `mount vxfs snapshot`。
  3. 在第一个客户端中执行 `UNLOCK TABLES`。
  4. 从快照中复制文件。
  5. 卸载快照。
- **其他文件系统**：
  - 类似功能也可在 LVM 或 ZFS 等文件系统中使用。
- **适用场景**：
  - 需要快速备份和恢复的大型数据库。

---

### 对比总结
| **备份方法**           | **特点**                                           | **适用场景**               |
| ---------------------- | -------------------------------------------------- | -------------------------- |
| **二进制日志增量备份** | 记录数据库更改，节省存储空间                       | 频繁备份、节省存储空间     |
| **副本备份**           | 减少对主服务器的影响，需备份元数据                 | 高负载生产环境             |
| **表恢复**             | 使用 `REPAIR TABLE` 或 `myisamchk -r` 修复损坏的表 | 表损坏但数据未完全丢失     |
| **文件系统快照备份**   | 快速备份和恢复，依赖文件系统快照功能               | 大型数据库、快速备份与恢复 |

## 备份与恢复策略

### 备份目标
- **恢复场景**：
  - 操作系统崩溃
  - 电源故障
  - 文件系统崩溃
  - 硬件问题（硬盘、主板等）
- **假设条件**：
  - 数据存储在支持事务和自动崩溃恢复的 `InnoDB` 存储引擎中。
  - MySQL 服务器在崩溃时处于负载状态。

---

## 操作系统崩溃或电源故障

### 恢复机制
- **数据可用性**：
  - MySQL 磁盘数据在重启后仍然可用。
- **InnoDB 自动恢复**：
  - `InnoDB` 读取日志文件，找到未刷新到数据文件的已提交和未提交事务。
  - 自动回滚未提交的事务，并将已提交的事务刷新到数据文件。
- **恢复步骤**：
  - 无需手动干预，`InnoDB` 自动完成恢复。

---

## 文件系统崩溃或硬件问题

### 恢复机制
- **数据不可用**：
  - MySQL 磁盘数据在重启后不可用。
  - 需要重新格式化磁盘、更换硬盘或修复硬件问题。
- **恢复步骤**：
  1. 修复硬件问题。
  2. 从备份中恢复 MySQL 数据。
  3. 确保备份策略已实施。

---

## 制定备份策略

### 完整备份
- **命令**：
  ```bash
  mysqldump --all-databases --master-data --single-transaction > backup_sunday_1_PM.sql
  ```
- **特点**：
  - 每周日 1 点进行完整备份。
  - 生成包含 SQL `INSERT` 语句的 `.sql` 文件。
  - 在备份开始时获取全局读锁。
- **适用场景**：
  - 定期全量备份。

### 增量备份
- **启用二进制日志**：
  - 启动 MySQL 服务器时使用 `--log-bin` 选项。
  - 二进制日志记录所有数据更改。
- **清理二进制日志**：
  ```bash
  mysqldump --single-transaction --flush-logs --master-data=2 \
            --all-databases --delete-master-logs > backup_sunday_1_PM.sql
  ```
- **适用场景**：
  - 频繁备份，节省存储空间。

---

## 使用备份进行恢复

### 恢复步骤
1. **恢复完整备份**：
   ```bash
   mysql < backup_sunday_1_PM.sql
   ```
   - 数据恢复到周日 1 点的状态。

2. **恢复增量备份**：
   - 使用二进制日志文件（如 `gbichot2-bin.000007` 和 `gbichot2-bin.000008`）：
     ```bash
     mysqlbinlog gbichot2-bin.000007 gbichot2-bin.000008 | mysql
     ```
   - 数据恢复到周二 1 点的状态。

3. **恢复最新更改**：
   - 如果二进制日志存储在安全位置（如 RAID 磁盘、SAN），可以恢复崩溃前的数据：
     ```bash
     mysqlbinlog gbichot2-bin.000009 ... | mysql
     ```

---

## 备份策略总结

### 关键点
1. **启用二进制日志**：
   - 默认情况下，MySQL 8.0 启用二进制日志。
   - 将二进制日志存储在与数据目录不同的物理设备上，以提高安全性。

2. **定期完整备份**：
   - 使用 `mysqldump` 进行在线、非阻塞的完整备份。

3. **定期增量备份**：
   - 使用 `FLUSH LOGS` 或 `mysqladmin flush-logs` 刷新日志，创建增量备份。

4. **自动恢复**：
   - 在操作系统崩溃或电源故障时，`InnoDB` 自动完成数据恢复。

---

### 对比总结
| **备份类型**       | **特点**                                    | **适用场景**           |
| ------------------ | ------------------------------------------- | ---------------------- |
| **完整备份**       | 包含所有数据，恢复简单                      | 定期全量备份           |
| **增量备份**       | 仅备份变化数据，节省存储空间                | 频繁备份、节省存储空间 |
| **二进制日志恢复** | 记录所有数据更改，用于恢复增量备份          | 崩溃后恢复最新数据     |
| **自动恢复**       | `InnoDB` 自动回滚未提交事务并刷新已提交事务 | 操作系统崩溃或电源故障 |

## MySQL Shell 导出工具

### 特点
- **并行导出**：支持多线程导出，提高效率。
- **文件压缩**：减少存储空间占用。
- **进度显示**：实时显示导出进度。
- **云功能**：
  - 支持 Oracle Cloud Infrastructure Object Storage 流式传输。
  - 提供 MySQL Database Service 兼容性检查和修改。
- **导入工具**：使用 MySQL Shell 的 `load dump` 工具轻松导入数据。

### 用途
1. **数据备份**：用于数据丢失时的恢复。
2. **副本设置**：作为设置副本的数据源。
3. **数据实验**：
   - 创建数据库副本，不影响原始数据。
   - 测试潜在的升级不兼容性。

---

## `mysqldump` 工具

### 输出类型
1. **SQL 格式输出**：
   - 默认输出格式。
   - 包含 `CREATE` 语句（创建数据库、表、存储过程等）和 `INSERT` 语句（插入数据）。
   - 保存为文件后，可使用 `mysql` 重新加载。
   - 示例：
     ```bash
     mysqldump [arguments] > file_name
     ```

2. **分隔文本格式输出**：
   - 使用 `--tab` 选项。
   - 每个表生成两个文件：
     - `tbl_name.sql`：包含 `CREATE TABLE` 语句。
     - `tbl_name.txt`：包含表数据，每行一条记录。
   - 示例：
     ```bash
     mysqldump --tab=/tmp db1
     ```

---

## 使用 `mysqldump` 导出数据

### 导出所有数据库
```bash
mysqldump --all-databases > dump.sql
```

### 导出指定数据库
```bash
mysqldump --databases db1 db2 db3 > dump.sql
```

### 导出单个数据库
```bash
mysqldump --databases test > dump.sql
```
或
```bash
mysqldump test > dump.sql
```

### 导出指定表
```bash
mysqldump test t1 t3 t7 > dump.sql
```

---

## 重新加载 SQL 格式备份

### 加载包含多个数据库的备份
```bash
mysql < dump.sql
```
或在 `mysql` 客户端中：
```sql
source dump.sql;
```

### 加载单个数据库备份
1. 创建数据库（如果需要）：
   ```bash
   mysqladmin create db1
   ```
2. 加载备份文件：
   ```bash
   mysql db1 < dump.sql
   ```
   或在 `mysql` 客户端中：
```sql
CREATE DATABASE IF NOT EXISTS db1;
USE db1;
source dump.sql;
```

---

## 重新加载分隔文本格式备份

### 加载步骤
1. 进入输出目录。
2. 使用 `mysql` 加载 `.sql` 文件创建表：
   ```bash
   mysql db1 < t1.sql
   ```
3. 使用 `mysqlimport` 或 `LOAD DATA` 加载 `.txt` 文件：
   ```bash
   mysqlimport db1 t1.txt
   ```
   或
   ```sql
   USE db1;
   LOAD DATA INFILE 't1.txt' INTO TABLE t1;
   ```

### 数据格式化选项
如果导出时使用了数据格式化选项（如字段分隔符、引号等），加载时需使用相同选项：
```bash
mysqlimport --fields-terminated-by=, --fields-enclosed-by='"' --lines-terminated-by=0x0d0a db1 t1.txt
```
或
```sql
USE db1;
LOAD DATA INFILE 't1.txt' INTO TABLE t1 
FIELDS TERMINATED BY ',' 
FIELDS ENCLOSED BY '"' 
LINES TERMINATED BY '\r\n';
```

---

### 对比总结
| **工具**                     | **特点**                                     | **适用场景**           |
| ---------------------------- | -------------------------------------------- | ---------------------- |
| **MySQL Shell 导出**         | 支持并行导出、压缩、进度显示和云功能         | 大规模数据导出、云环境 |
| **`mysqldump` SQL 格式**     | 生成 SQL 语句，便于跨平台迁移和选择性恢复    | 小型数据库、逻辑备份   |
| **`mysqldump` 分隔文本格式** | 生成 `.sql` 和 `.txt` 文件，适合快速导入导出 | 数据导出与导入         |

## 数据库复制与迁移

### 复制数据库
1. **导出数据库**：
   ```bash
   mysqldump db1 > dump.sql
   ```
2. **创建新数据库**：
   ```bash
   mysqladmin create db2
   ```
3. **导入数据**：
   ```bash
   mysql db2 < dump.sql
   ```
- **注意**：不要使用 `--databases` 选项，否则会在导出文件中包含 `USE db1` 语句，覆盖导入时的目标数据库。

---

## 从一台服务器复制数据库到另一台服务器

### 方法 1：使用 `--databases` 选项
1. **在服务器 1 上导出**：
   ```bash
   mysqldump --databases db1 > dump.sql
   ```
2. **将导出文件复制到服务器 2**。
3. **在服务器 2 上导入**：
   ```bash
   mysql < dump.sql
   ```

### 方法 2：不使用 `--databases` 选项
1. **在服务器 1 上导出**：
   ```bash
   mysqldump db1 > dump.sql
   ```
2. **在服务器 2 上创建数据库**：
   ```bash
   mysqladmin create db1
   ```
3. **在服务器 2 上导入**：
   ```bash
   mysql db1 < dump.sql
   ```

---

## 导出存储程序

### 选项说明
- `--events`：导出事件调度器事件。
- `--routines`：导出存储过程和函数。
- `--triggers`：导出表的触发器（默认启用）。

### 示例
- 导出存储过程和函数：
  ```bash
  mysqldump --routines db1 > dump.sql
  ```
- 导出事件：
  ```bash
  mysqldump --events db1 > dump.sql
  ```
- 禁用触发器导出：
  ```bash
  mysqldump --skip-triggers db1 > dump.sql
  ```

---

## 分别导出表结构和数据

### 导出表结构
- **命令**：
  ```bash
  mysqldump --no-data test > dump-defs.sql
  ```
- **包含存储程序和事件**：
  ```bash
  mysqldump --no-data --routines --events test > dump-defs.sql
  ```

### 导出表数据
- **命令**：
  ```bash
  mysqldump --no-create-info test > dump-data.sql
  ```

---

## 使用 `mysqldump` 测试升级兼容性

### 步骤
1. **在生产服务器上导出表结构**：
   ```bash
   mysqldump --all-databases --no-data --routines --events > dump-defs.sql
   ```
2. **在升级后的服务器上导入表结构**：
   ```bash
   mysql < dump-defs.sql
   ```
3. **检查警告或错误**：
   - 确认表结构处理正确。

4. **在生产服务器上导出表数据**：
   ```bash
   mysqldump --all-databases --no-create-info > dump-data.sql
   ```
5. **在升级后的服务器上导入表数据**：
   ```bash
   mysql < dump-data.sql
   ```
6. **验证数据**：
   - 检查表内容并运行测试查询。

---

### 对比总结
| **操作**               | **命令**                                                     | **用途**                       |
| ---------------------- | ------------------------------------------------------------ | ------------------------------ |
| **复制数据库**         | `mysqldump db1 > dump.sql` + `mysql db2 < dump.sql`          | 在同一服务器上复制数据库       |
| **跨服务器复制数据库** | `mysqldump --databases db1 > dump.sql` + `mysql < dump.sql`  | 从一台服务器复制到另一台服务器 |
| **导出存储程序**       | `mysqldump --routines --events db1 > dump.sql`               | 导出存储过程、函数和事件       |
| **导出表结构**         | `mysqldump --no-data test > dump-defs.sql`                   | 仅导出表结构                   |
| **导出表数据**         | `mysqldump --no-create-info test > dump-data.sql`            | 仅导出表数据                   |
| **测试升级兼容性**     | `mysqldump --all-databases --no-data --routines --events > dump-defs.sql` | 验证升级后的表结构兼容性       |

## 时间点恢复（Point-in-Time Recovery）

### 概述
- **定义**：时间点恢复是指将数据恢复到某个特定时间点的状态。
- **步骤**：
  1. 恢复完整备份，使服务器回到备份时的状态。
  2. 使用二进制日志逐步恢复从备份时间点到目标时间点的数据更改。

---

## 使用二进制日志进行时间点恢复

### 1. 查看二进制日志
- **查看所有二进制日志文件**：
  ```sql
  SHOW BINARY LOGS;
  ```
- **查看当前二进制日志文件**：
  ```sql
  SHOW MASTER STATUS;
  ```

### 2. 应用二进制日志
- **基本命令**：
  ```bash
  mysqlbinlog binlog_files | mysql -u root -p
  ```
- **处理加密的二进制日志**（MySQL 8.0.14 及以上版本）：
  ```bash
  mysqlbinlog --read-from-remote-server --host=host_name --port=3306 --user=root --password --ssl-mode=required binlog_files | mysql -u root -p
  ```

### 3. 查看和编辑二进制日志
- **查看日志内容**：
  ```bash
  mysqlbinlog binlog_files | more
  ```
- **保存日志内容到文件**：
  ```bash
  mysqlbinlog binlog_files > tmpfile
  ```
- **编辑文件后应用**：
  ```bash
  mysql -u root -p < tmpfile
  ```

### 4. 安全处理多个二进制日志
- **避免问题**：使用单个连接处理所有二进制日志文件。
- **示例**：
  ```bash
  mysqlbinlog binlog.000001 binlog.000002 | mysql -u root -p
  ```
- **保存到文件后处理**：
  ```bash
  mysqlbinlog binlog.000001 > /tmp/statements.sql
  mysqlbinlog binlog.000002 >> /tmp/statements.sql
  mysql -u root -p -e "source /tmp/statements.sql"
  ```
- **处理包含 GTIDs 的日志**：
  ```bash
  mysqlbinlog --skip-gtids binlog.000001 > /tmp/dump.sql
  mysqlbinlog --skip-gtids binlog.000002 >> /tmp/dump.sql
  mysql -u root -p -e "source /tmp/dump.sql"
  ```

---

## 使用事件位置进行时间点恢复

### 示例场景
- **问题**：在 2020 年 3 月 11 日 20:06:00 左右，执行了一条删除表的 SQL 语句。
- **目标**：将数据库恢复到删除表之前的状态。

### 步骤
1. **恢复完整备份**：
   - 恢复到目标时间点之前的完整备份。
   - 记录恢复后的二进制日志位置，并重启服务器。

2. **查找目标时间点的日志位置**：
   - 使用 `mysqlbinlog` 查找目标时间点附近的事件位置。
   - 示例：
     ```bash
     mysqlbinlog --start-datetime="2020-03-11 20:05:00" --stop-datetime="2020-03-11 20:07:00" /var/lib/mysql/bin.123456
     ```

3. **应用二进制日志**：
   - 从恢复后的日志位置（如 155）到目标时间点之前的日志位置（如 232）：
     ```bash
     mysqlbinlog --start-position=155 --stop-position=232 /var/lib/mysql/bin.123456 | mysql -u root -p
     ```

4. **恢复目标时间点之后的数据**：
   - 如果需要恢复目标时间点之后的数据，从目标时间点的日志位置（如 355）开始应用：
     ```bash
     mysqlbinlog --start-position=355 /var/lib/mysql/bin.123456 | mysql -u root -p
     ```

---

### 对比总结
| **操作**             | **命令**                                                     | **用途**               |
| -------------------- | ------------------------------------------------------------ | ---------------------- |
| **查看二进制日志**   | `SHOW BINARY LOGS;` 或 `SHOW MASTER STATUS;`                 | 获取二进制日志文件信息 |
| **应用二进制日志**   | `mysqlbinlog binlog_files | mysql -u root -p`                | 恢复数据更改           |
| **处理加密日志**     | `mysqlbinlog --read-from-remote-server ...`                  | 读取加密的二进制日志   |
| **编辑日志内容**     | `mysqlbinlog binlog_files > tmpfile` + `mysql -u root -p < tmpfile` | 选择性恢复日志内容     |
| **安全处理多个日志** | `mysqlbinlog binlog.000001 binlog.000002 | mysql -u root -p` | 避免临时表问题         |
| **时间点恢复**       | `mysqlbinlog --start-position=155 --stop-position=232 ...`   | 恢复到特定时间点       |